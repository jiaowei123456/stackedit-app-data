# TWIN: TWo-stage Interest Network for Lifelong User Behavior Modeling in CTR Prediction
[原文链接]()
## 0 摘要：
长期用户行为建模，即从数月甚至数年的丰富历史行为中提取用户的潜在兴趣，在现代点击率预测系统中起着核心作用。传统算法大多遵循两个级联阶段：一个简单的通用搜索单元（GSU）用于对数万条长期行为进行快速粗略搜索，以及一个精确搜索单元（ESU）用于对 GSU 中选出的少量候选行为进行有效的目标关注（TA）。尽管高效，但现有算法大多存在一个关键缺陷：**GSU 和 ESU 之间目标行为相关性度量不一致。因此，其 GSU 通常会遗漏高度相关的行为，而检索出 ESU 认为不相关的行为**。在这种情况下，无论 ESU 中如何分配注意力，其目标关注大多偏离了用户的实际兴趣，从而降低了整体点击率预测的准确性。为解决这种不一致性，我们提出了两阶段兴趣网络（TWo-stage Interest Network， TWIN），其中我们的**保持一致性的通用搜索单元（ConsistencyPreserved General Search Unit，CP-GSU）采用了与 ESU 中的目标关注相同的度量标准，使两个阶段成为“双胞胎”**。具体而言，为突破其计算瓶颈并将其从 ESU 扩展到 GSU，即从行为长度 $10^2$ 扩展到在长度为 $10^4 - 10^5$ 的范围内，我们通过**行为特征拆分构建了一种新颖的注意力机制**。对于行为的固有特征，我们通过高效的**预计算**和**缓存策略**计算其线性投影。而对于用户 - 项目交叉特征，我们在注意力得分计算中将其压缩为一个一维偏差项，以节省计算成本。两个阶段的一致性，以及 CP-GSU 中基于 TA 的有效相关性度量，为 CTR 预测带来了显著的性能提升。在来自快手的 460 亿规模的真实生产数据集上的离线实验以及在线 A/B 测试表明，TWIN 超过了所有比较的 SOTA 算法。通过优化在线基础设施，我们减少了 99.3% 的计算瓶颈，这有助于 TWIN 在快手的成功部署，每天为数亿活跃用户提供主要流量服务。

## 背景
近年来，关于两阶段终身行为建模的大量新研究相继涌现，而其核心差异在于粗略选取目标相关行为的 GSU 策略。例如，SIM Hard [19] 仅从与目标对象同类别中选择行为，而 SIM Soft [19] 则通过内积运算，利用预先训练好的项目嵌入来计算目标行为的相关性得分，并选择相关性最高的行为[19]。ETA 利用局部敏感哈希（LSH）和汉明距离来近似相关性得分的计算[3]。SDIM 通过多轮哈希碰撞从具有与目标行为相同哈希签名的行为中进行抽样[1]，等等。

## 1 论文解决的问题：
尽管已经进行了广泛的研究，但现有的两阶段终身行为建模算法仍然存在一个关键的局限性：GSU 和 ESU 之间的不一致性。具体而言，GSU 中使用的目标行为相关性指标既粗糙又与 ESU 中使用的 TA 不一致。因此，GSU 可能会遗漏相关行为，但会检索到 ESU 认为不相关的行为，从而浪费了 ESU 的宝贵计算资源。在这种情况下，无论如何分配注意力，ESU 中的 TA 都会偏离真实的用户兴趣，从而降低整体的 CTR 预测准确性。

## 2 论文创新点：
为解决这种不一致性问题，我们提出了 TWIN：一种用于长期用户行为建模的两阶段兴趣网络。其中，
* 1）具体而言，对于一个行为所具有的视频固有特征（例如视频 ID、作者、时长、主题），这些特征在用户/行为序列之间是共享的，我们通过高效的预计算和缓存策略加速了这些特征的投影。
* 2）而对于一个行为的用户-视频交叉特征（例如用户的点击时间戳、播放时间、评分），由于无法进行缓存，我们通过将它们的投影压缩为偏差项来简化 TA 架构。借助优化的在线基础设施，我们成功地将 TA 的适用序列长度从 ESU 中的$10^2$  扩展到 CP-GSU 中的 $10^4 - 10^5$。两个阶段之间的一致性，再加上 CP-GSU 中基于 TA 的有效相关性度量，使得点击率预测的性能有了显著提升。

### 2.1 TWIN：两阶段兴趣网络：
我们将所提出的算法命名为“TWIN”，以强调 CP-GSU 采用的关联评估指标与 ESU 相同。请注意，这种一致性并非易事，原因在于：  
• 有效的行为建模算法通常基于多头目标注意力机制（MHTA）[25]，它通过强调目标相关行为来精确捕捉用户兴趣。然而，由于计算复杂度较高，MHTA 适用的行为序列长度大多限制在几百个以内。  
• 为了全面捕捉用户的长期兴趣，CP-GSU 应该涵盖用户过去几个月的行为，这可能很容易达到数万次。而这个序列长度远远超出了传统 MHTA 的处理能力，因为在线系统的严格低延迟要求使得 MHTA 无法处理如此长的序列长度。  
#### 2.1.1 行为特征拆分与线性投影(Feature Splits and Transform)
![输入图片说明](/imgs/2025-07-21/TWyTHHAamyU1JUgM.png)
其中计算复杂度主要为交叉特征，为$L*C$的矩阵乘$C*1$，复杂度为$L*C$，因此交叉特征将每个序列的emb维度dim压缩到了1。
![输入图片说明](/imgs/2025-07-21/oHFNkec453JGy7ie.png)
#### 2.1.1 高效TA计算(Efficient Target Attention)
![输入图片说明](/imgs/2025-07-21/I64fedFnChw3ujDf.png)
在$GSU$阶段先根据$alpha$

## 4 模型结构与实现代码：


## 5 实验与分析：

<!--stackedit_data:
eyJoaXN0b3J5IjpbMjA3OTQ1NTg1MSwtMTM2NjYzOTY4LC0xNT
E1NDE2NTQwLDEyNjU2NDE2ODIsMTc1MDEwNDMxNSwxNzE2NjIy
OTU5LDE0MzYwNzE2NzUsMTY1MDE0MjY4NCw3ODg0MDg1NjAsOT
g0MjkzOTc5LC0xMjgzMTgxMDg1LC0xNzEzMDkwMzE2XX0=
-->